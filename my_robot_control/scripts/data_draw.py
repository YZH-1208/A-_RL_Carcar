import csv
import matplotlib.pyplot as plt
import matplotlib.image as mpimg
from sklearn.cluster import KMeans
import numpy as np
from scipy.spatial import cKDTree

def transform_coordinates(x, y):
    new_x = 2000 + x * 20
    new_y = 2000 - y * 20
    return new_x, new_y

def grid_filter(obstacles, grid_size=0.5):
    obstacles = np.array(obstacles)
    # 按照 grid_size 取整
    grid_indices = (obstacles // grid_size).astype(int)
    # 找到唯一的网格
    unique_indices = np.unique(grid_indices, axis=0)
    # 返回网格中心点
    filtered_points = unique_indices * grid_size + grid_size / 2
    return filtered_points

# Load the image
img_path = '/home/daniel/maps/my_map0924.png'  # Example image path; replace as needed
img = mpimg.imread(img_path)

if len(img.shape) == 3 and img.shape[2] == 4:
    img = img[:,:,:3]
    img = np.dot(img[..., :3], [0.2989, 0.5870, 0.1140])
elif len(img.shape) == 3 and img.shape[2] == 3:
    # 图像是 RGB 格式，转换为灰度
    img = np.dot(img[..., :3], [0.2989, 0.5870, 0.1140])

if img.max() <= 1.0:
    img = img*255.0

obstacle_indices = np.where(img<150)

obstacle_pixels_y = obstacle_indices[0]
obstacle_pixels_x = obstacle_indices[1]

def inverse_transform_coordinates(x_pixel, y_pixel):
    x = (x_pixel-2000)/20.0
    y = (2000- y_pixel)/20.0
    return x,y

obstacle_x_transformed = []
obstacle_y_transformed = []

for x_pix, y_pix in zip(obstacle_pixels_x, obstacle_pixels_y):
    x_trans, y_trans = inverse_transform_coordinates(x_pix, y_pix)
    obstacle_x_transformed.append(x_trans)
    obstacle_y_transformed.append(y_trans)

# 将障碍物点构建为 KDTree
obstacle_points = np.column_stack((obstacle_x_transformed, obstacle_y_transformed))
obstacle_tree = cKDTree(obstacle_points)

before_adjust_points_good = [(-6.4080, -1.1666), (-5.3892, -1.0802), (-4.3626, -1.0032), (-3.3055, -0.9681), (-2.2771, -0.8968), (-1.1807, -0.8445), (-0.1155, -0.7618), (0.9490, -0.6745), (1.9527, -0.6377), (3.0705, -0.5868), (4.1599, -0.5043), (5.2569, -0.4223), (6.3557, -0.3996), (7.4131, -0.3702), (8.5424, -0.3024), (9.6369, -0.2512), (10.6981, -0.2736), (11.7643, -0.1551), (12.7754, -0.0854), (13.8685, -0.0302), (14.9090, 0.0746), (16.0013, 0.1684), (17.0656, 0.2538), (18.0911, 0.3497), (19.0993, 0.4367), (20.1566, 0.5574), (21.2321, 0.6047), (22.2546, 0.6669), (23.2880, 0.6967), (24.3430, 0.7378), (25.3915, 0.7777), (26.4767, 0.8673), (27.5571, 0.9465), (28.6435, 1.0482), (29.7431, 1.1225), (30.8329, 1.2397), (31.8761, 1.2732), (32.8904, 1.3245), (33.9442, 1.3995), (35.0187, 1.4454), (36.0335, 1.5220), (37.0678, 1.6257), (38.1029, 1.6259), (39.1803, 1.6816), (40.2585, 1.7234), (41.2931, 1.7433), (42.3844, 1.7979), (43.4562, 1.8682), (44.4835, 2.0215), (45.5166, 2.0595), (46.6287, 2.1675), (47.6770, 2.2117), (48.7845, 2.2827), (49.8344, 2.3362), (50.8708, 2.3616), (51.9392, 2.3956), (52.9917, 2.5111), (54.0028, 2.5951), (55.0883, 2.6934), (56.1455, 2.7057), (57.2318, 2.8695), (58.0823, 3.4761), (58.7069, 4.4118), (58.8974, 5.4242), (58.8391, 6.5288), (58.8141, 7.5521), (58.8205, 8.5551), (58.7821, 9.5803), (58.7537, 10.5984), (58.7314, 11.6110), (58.6999, 12.6477), (58.6201, 13.6819), (58.4868, 14.6940), (58.1982, 15.6860), (57.6005, 16.5418), (56.8650, 17.2482), (55.9440, 17.7136), (54.9350, 17.8804), (53.8818, 17.8926), (52.8526, 17.6887), (51.8069, 17.3650), (50.7820, 17.0685), (49.7811, 16.8080), (48.7422, 16.5641), (47.7084, 16.4034), (46.7005, 16.3081), (45.5746, 16.2254), (44.4787, 16.2452), (43.4592, 16.2094), (42.4062, 16.1248), (41.3707, 16.0816), (40.2991, 16.0249), (39.3056, 16.1674), (38.2934, 16.4402), (37.2497, 16.4955), (36.2612, 16.1945), (35.4334, 15.4743), (34.9644, 14.4999), (34.3928, 13.6417), (33.6440, 12.9482), (32.6778, 12.5165), (31.6562, 12.3605), (30.6498, 12.2463), (29.6277, 12.1818), (28.5717, 12.0370), (27.5491, 12.0087), (26.4597, 11.9145), (25.4396, 11.7903), (24.3838, 11.6871), (23.2932, 11.6490), (22.2616, 11.5482), (21.2405, 11.5063), (20.1746, 11.4361), (19.1583, 11.4008), (18.1215, 11.3846), (17.0834, 11.3349), (16.0508, 11.3173), (14.9897, 11.2045), (13.9443, 11.1460), (12.8736, 11.0952), (11.8041, 11.0898), (10.7257, 10.9630), (9.7111, 11.1788), (8.9449, 11.9389), (8.4988, 12.8635), (7.8121, 13.7247), (6.8239, 14.1929), (5.8220, 14.1822), (4.8487, 13.8662), (3.9465, 13.4316), (2.9931, 13.1282), (1.9657, 13.0064), (0.8969, 12.9771), (-0.1702, 12.8787), (-1.1865, 12.8195), (-2.2137, 12.7135), (-3.2513, 12.6368), (-4.2855, 12.6409), (-5.3050, 12.8183), (-6.2814, 13.0364), (-7.3018, 13.1883), (-8.3437, 13.3485), (-9.3908, 13.3478), (-10.4534, 13.3072), (-11.5001, 13.2976), (-12.5815, 13.1350), (-13.4808, 12.6131), (-14.1301, 11.7834), (-14.5313, 10.8416), (-14.6299, 9.7889), (-14.5990, 8.6957), (-14.5372, 7.6777), (-14.4488, 6.5676), (-14.3769, 5.5304), (-14.3704, 4.4732), (-14.2815, 3.4237), (-14.1639, 2.3726), (-14.1611, 1.3357), (-14.0231, 0.3118), (-13.5913, -0.7091), (-12.7973, -1.3941), (-11.8401, -1.7365), (-10.7485, -1.6706), (-9.7031, -1.5861), (-8.6572, -1.5451), (-7.5826, -1.5293), (-6.5365, -1.5304), (-5.4661, -1.3837)]


before_adjust_points_bad = [(-6.4981, -1.0627),
            (-5.4541, -1.0117),
            (-4.4041, -0.862),
            (-3.3692, -1.0294),
            (-2.295, -1.114),
            (-1.2472, -1.0318),
            (-0.1614, -0.6948),
            (0.8931, -0.8804),
            (1.9412, -0.8604),
            (2.9804, -0.7229),
            (3.874, -0.2681),
            (4.9283, -0.1644),
            (5.9876, -0.345),
            (7.019, -0.5218),
            (7.9967, -0.2338),
            (9.0833, -0.1096),
            (10.1187, -0.3335),
            (11.1745, -0.6322),
            (12.1693, -0.8619),
            (13.1291, -0.4148),
            (14.1217, -0.0282),
            (15.1261, 0.123),
            (16.1313, 0.4439),
            (17.1389, 0.696),
            (18.1388, 0.6685),
            (19.2632, 0.5127),
            (20.2774, 0.2655),
            (21.2968, 0.0303),
            (22.3133, -0.0192),
            (23.2468, 0.446),
            (24.1412, 0.9065),
            (25.1178, 0.5027),
            (26.1279, 0.4794),
            (27.0867, 0.8266),
            (28.0713, 1.4229),
            (29.1537, 1.3866),
            (30.2492, 1.1549),
            (31.385, 1.0995),
            (32.4137, 1.243),
            (33.4134, 1.5432),
            (34.4137, 1.5904),
            (35.4936, 1.5904),
            (36.5067, 1.5607),
            (37.5432, 1.5505),
            (38.584, 1.7008),
            (39.6134, 1.9053),
            (40.5979, 2.0912),
            (41.6557, 2.3779),
            (42.5711, 2.8643),
            (43.5911, 2.9725),
            (44.5929, 3.0637),
            (45.5919, 2.9841),
            (46.6219, 2.9569),
            (47.6314, 3.0027),
            (48.7359, 2.832),
            (49.5462, 2.1761),
            (50.5982, 2.1709),
            (51.616, 2.3573),
            (52.6663, 2.5593),
            (53.7532, 2.5325),
            (54.7851, 2.5474),
            (55.8182, 2.5174),
            (56.8358, 2.6713),
            (57.8557, 2.8815),
            (58.8912, 3.0949),
            (59.7436, 3.6285),
            (60.5865, 4.2367),
            (60.6504, 5.2876),
            (60.7991, 6.3874),
            (60.322, 7.3094),
            (59.8004, 8.1976),
            (59.4093, 9.195),
            (59.1417, 10.1994),
            (59.1449, 11.2274),
            (59.5323, 12.2182),
            (59.8637, 13.2405),
            (60.5688, 14.0568),
            (60.6266, 15.1571),
            (60.007, 15.9558),
            (59.0539, 17.0128),
            (57.9671, 17.326),
            (56.9161, 16.7399),
            (55.9553, 17.0346),
            (54.9404, 17.0596),
            (53.9559, 16.8278),
            (52.9408, 16.8697),
            (51.9147, 16.7642),
            (50.9449, 16.4902),
            (49.9175, 16.3029),
            (48.8903, 16.1165),
            (47.7762, 16.0994),
            (46.7442, 16.0733),
            (45.7566, 15.8195),
            (44.756, 15.7218),
            (43.7254, 15.9309),
            (42.6292, 15.8439),
            (41.6163, 15.8177),
            (40.5832, 15.7881),
            (39.5617, 15.773),
            (38.5099, 15.5648),
            (37.692, 14.9481),
            (36.8538, 14.3078),
            (35.8906, 13.8384),
            (34.8551, 13.6316),
            (33.8205, 13.5495),
            (32.7391, 13.4423),
            (31.7035, 13.1056),
            (30.6971, 12.7802),
            (29.6914, 12.5216),
            (28.7072, 12.3238),
            (27.6442, 12.0953),
            (26.5991, 11.9873),
            (25.5713, 11.9867),
            (24.488, 12.0679),
            (23.4441, 12.0246),
            (22.3169, 11.7745),
            (21.3221, 11.538),
            (20.3265, 11.4243),
            (19.2855, 11.5028),
            (18.2164, 11.5491),
            (17.1238, 11.6235),
            (16.0574, 11.4029),
            (14.982, 11.2479),
            (13.9491, 11.0487),
            (12.9017, 11.1455),
            (11.8915, 11.4186),
            (10.8461, 11.6079),
            (9.9029, 12.0097),
            (9.0549, 12.5765),
            (8.4289, 13.4238),
            (7.4035, 13.6627),
            (6.3785, 13.5659),
            (5.3735, 13.4815),
            (4.3971, 13.1044),
            (3.3853, 13.2918),
            (2.3331, 13.0208),
            (1.2304, 12.9829),
            (0.2242, 13.094),
            (-0.807, 12.9358),
            (-1.8081, 12.8495),
            (-2.7738, 13.3168),
            (-3.4822, 14.0699),
            (-4.5285, 14.2483),
            (-5.5965, 13.9753),
            (-6.5324, 13.6016),
            (-7.3092, 12.8632),
            (-8.3255, 12.9916),
            (-9.1914, 13.7593),
            (-10.2374, 14.069),
            (-11.2162, 13.7566),
            (-11.653, 12.8061),
            (-11.6989, 11.7238),
            (-11.8899, 10.7353),
            (-12.6174, 10.0373),
            (-12.7701, 8.9551),
            (-12.4859, 7.9523),
            (-12.153, 6.8903),
            (-12.4712, 5.819),
            (-13.0498, 4.8729),
            (-13.1676, 3.8605),
            (-12.4328, 3.1822),
            (-12.1159, 2.1018),
            (-12.8436, 1.2659),
            (-13.3701, 0.2175),
            (-13.0514, -0.8866),
            (-12.3046, -1.619),
            (-11.2799, -1.472),
            (-10.1229, -1.3051),
            (-9.1283, -1.4767),
            (-8.1332, -1.2563)
]

astar_points = [(-6.507288735160595, -1.062651895589824), (-5.456445420333064, -1.0398784614920535), (-4.3962890501942296, -1.0250849201956254), 
(-3.04394371332952, -0.9953538201626039), (-1.8999295940186478, -0.9549299345734845), (-0.8355784573302598, -0.8642239954191399), 
(0.26654799701384374, -0.7845937988617849), (1.46171966511453, -0.6959566527608158), (2.642822091473855, -0.5683606443703223), 
(3.75430256143664, -0.3891866444953231), (4.87556929848896, -0.2783530159295584), (6.101111471503717, -0.15682861021894018), 
(7.209159980809988, -0.09002558709313588), (8.305078297165009, -0.06442866714759522), (9.479689131670487, -0.031630430818367854), 
(10.70168917789225, 0.002289458800208667), (11.964283896644455, 0.037599388069341384), (13.258865639467405, 0.07454215470809898), 
(14.5204272215042, 0.12117748780176568), (15.70283056431675, 0.2770776200278619), (16.796645304471706, 0.44482281209341284), 
(17.933018596982933, 0.554664893096948), (19.058184160750663, 0.6461224640553205), (20.112713127700626, 0.7088027549527812), 
(21.49908012124714, 0.7598482664942272), (22.673421111821874, 0.8030402625332014), (23.89505475565036, 0.8662066795076471), 
(25.13614948763923, 0.9206618298649701), (26.365041770147894, 0.9573272534887552), (27.45632770426062, 1.1931957629354015), 
(28.778530604461565, 1.293922590469235), (30.181052883599182, 1.2697150420618997), (31.308701996835808, 1.267048084890702), 
(32.42353151254724, 1.3476872298153806), (33.57465949503415, 1.4221775560597352), (34.82313036110202, 1.5023413587516472), 
(36.090991348687645, 1.5828016125104791), (37.35110191794788, 1.6629306409475249), (38.631561491995775, 1.7498882735793375), 
(39.80179134304813, 1.8914374231698656), (40.88209726878967, 2.048489451741698), (41.9866275588856, 2.199223068669923), 
(43.170956596928164, 2.35226723101759), (44.34165866556021, 2.483185431693005), (45.421903285304175, 2.5683142697389885), 
(46.46418709050317, 2.622327491607832), (47.532725456570134, 2.595738116407162), (48.60313857148652, 2.3944302036533567), 
(49.748435246617284, 2.24148171921893), (50.8687437848462, 2.3117891984881758), (52.0508501688518, 2.4008541841266697), 
(53.27213681136831, 2.484689169811523), (54.485700878972175, 2.5644842680887248), (55.761747666036925, 2.6462847624652923), 
(57.09618734657903, 2.7921349145627494), (58.36869688339108, 3.0412987079241356), (59.234769915964236, 4.036265737371122),
(59.64465215749869, 5.227497734928834), 
(59.814192759241315, 6.468964121722906), 
(59.66072631802936, 7.732993143528124), 
(59.46099403190419, 9.050662626669917), 
(59.27490836746362, 10.408047519432658), 
(59.530629725440754, 11.716133425884262), 
(59.84503886627357, 13.056815762218266), 
(60.090104475053124, 14.082853231808118), 
(59.70580169690828, 15.197052697957819), 
(58.98165040244643, 16.085036007685673), 
(57.882795802545864, 16.517849897802396), 
(56.6558313244607, 16.788072753650276), 
(55.37782130806086, 16.904143418510017), 
(53.99823370966597, 16.906500986815246), 
(52.86314243732122, 16.864417011942795), 
(51.483860018265595, 16.72218891626275), 
(50.203695905494044, 16.52723460875866), 
(48.92598157366066, 16.31738382864992), 
(47.70119374384912, 16.04254839853688), 
(46.66292178561043, 16.31938810805406), 
(45.5271182912151, 16.134327584787744), 
(44.33854711674305, 16.138378000729225), 
(43.237050617159895, 16.038313272882127), 
(42.12438875046733, 16.052744774928083), 
(40.85894448402668, 16.27482797583376), 
(39.742423408202285, 16.412056094824205), 
(38.71257348555653, 16.244445826297394), 
(37.60895734163561, 15.771347562054721), 
(36.670715815532915, 15.065247997738771), 
(35.7738573078533, 14.327506417116938), 
(35.25610771362484, 13.18024180785533), 
(34.26473652004709, 12.726396939765), 
(33.10185842482858, 12.656368229047922), 
(31.91954168166553, 12.664289432696286), 
(30.76319888432515, 12.486067350640194), 
(29.739740017051833, 12.052511472031455), 
(28.535913588230198, 12.1041619980617), 
(27.337652248573193, 12.109684469053423), 
(26.286121282022243, 12.113475479390582), 
(25.143601437919834, 12.117364210454772), 
(24.010424511870436, 12.078550839729848), 
(22.679353453981367, 11.956843582222879), 
(21.610298477900997, 11.846109091145935), 
(20.433801651132832, 11.725523965124713), 
(19.23228718292105, 11.610978934521357), 
(18.100461155798424, 11.537120038398955), 
(17.01627923653334, 11.49683965624143), 
(15.865281630178702, 11.430746695398302), 
(14.712230059476667, 11.368777005708457), 
(13.510613645587766, 11.325559098215557), 
(12.302054289005074, 11.319492911758026), 
(11.02457192181468, 11.665874079922075), 
(10.04629633388977, 12.500892381135685),
(9.761310944832639, 13.210913571160368),
(8.825086100213435, 13.927958249014354),
(7.560148627663788, 14.233030265631397),
(6.277496021842945, 14.21740929457387),
(4.926983910173929, 14.107479751341133),
(3.8726714032772853, 14.016409947151152),
(2.619001459904777, 13.907570516443023),
(1.486997405872667, 13.810059944989218),
(0.4443881800989164, 13.721268575398431),
(-0.8003662921041653, 13.616949876882671),
(-1.988834978365651, 13.534210125120207),
(-3.2372368911088323, 13.587260489819975),
(-4.4826575719356985, 13.694114554056535),
(-5.576087707298985, 13.785598190750397),
(-6.709431817665974, 13.870405969922256),
(-7.75844544047177, 13.905121716461991),
(-9.09415989982145, 13.85637469571632),
(-10.321038258605952, 13.547471535597543),
(-11.205981343606375, 12.745929548912624),
(-11.811020317693913, 11.762018318734022),
(-12.078095838339511, 10.585139467024538),
(-12.1942371281073, 9.304404320682224),
(-12.261642789303437, 8.049276611755987),
(-12.28401561839908, 6.860503763191577),
(-12.27730867084142, 5.64226808120721),
(-12.24433545977436, 4.4257890375222),
(-12.17617224540995, 3.1306292673412526),
(-11.84041838764631, 2.0852774364457414),
(-11.274410516458287, 1.1437689477777577),
(-10.659312135780478, 0.22490920333943465),
(-9.639527052685672, -0.22913576895298907),
(-8.338434963655365, -0.3108385650223267),
(-7.028524520945899, -0.393046264130378),
(-5.996482355978194, -0.6013564601252632)
]

# 将路径点转换为数组
path_points = np.array(before_adjust_points_bad)

# 计算每个路径点到最近障碍物的距离
distances, indices = obstacle_tree.query(path_points, k=1)

# 打印每个路径点到最近障碍物的距离
for i, (point, distance) in enumerate(zip(path_points, distances)):
    print(f"路径点 {i}：坐标 {point}，到最近障碍物的距离 {distance}")

# 计算平均距离
average_distance = distances.mean()
print(f"\n平均距离为：{average_distance}")

fig, ax = plt.subplots(figsize=(12, 8))
fig.patch.set_facecolor('white')  # 設置整個 figure 的背景為白色
ax.imshow(img)

x_original_bad, y_original_bad  = zip(*before_adjust_points_bad)
x_original_bad = [2000+ 20 * (x) for x in x_original_bad]
y_original_bad = [2000- 20 * (y) for y in y_original_bad]

ax.plot(x_original_bad, y_original_bad, 'o-', color='red', markersize = 2, linewidth =1, label= "Before Adjust Path")
# Plot the A* path points

x_original_good, y_original_good = zip(*before_adjust_points_good)
x_original_good = [2000+ 20* (x) for x in x_original_good]
y_original_good = [2000- 20* (y) for y in y_original_good]

ax.plot(x_original_good, y_original_good, 'o-', color='blue', markersize = 2, linewidth =1, label= "Before Adjust Path")
# Plot the A* path points

x_astar, y_astar = zip(*astar_points)
# 將 astar_points 的 x 和 y 分別轉換
x_astar = [2000 + 20 * (x) for x in x_astar]
y_astar = [2000 - 20 * (y) for y in y_astar]

ax.plot(x_astar,y_astar, 'o-', color='purple', markersize=3, linewidth=2, label="A* Path")
# Add legend
ax.legend(loc='upper right')

# Remove coordinate display on plot
ax.set_xticks([])
ax.set_yticks([])

# Show the image with annotated points
plt.title("Path Visualization with A*")
plt.show()